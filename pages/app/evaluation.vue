<script setup lang="ts">
import { computed, watch } from "vue";
import { useRouter, useState } from "#imports";
import type { DmpElement } from "~/server/utils/splitMdByElements";

const router = useRouter();
const toast = useToast();

const dmpState = useState<DmpElement[]>("dmpData");
const dmpIndex = useState<number>("dmpIndex");
const assignedDmps = useState<string[]>("assignedDmps");
const evaluationsPerDmp = useState<any[][][]>("evaluationsPerDmp", () => []);
const evaluations = useState<any[][]>("evaluations", () => []);
const currentPage = useState<number>("currentPage", () => 0);
const helpTexts = [
  // Page 1: ele1-a, b, c, ele2, ele3
  "Summarize the types and estimated amount of scientific data expected to be generated in the project",
  "Describe which scientific data from the project will be preserved and shared and provide the rationale for this decision",
  "Briefly list the metadata, other relevant data, and any associated documentation (e.g., study protocols and data collection instruments) that will be made accessible to facilitate interpretation of the scientific data",
  "State whether specialized tools, software, and/or code are needed to access or manipulate shared scientific data, and if so, provide the name(s) of the needed tool(s) and software and specify how they can be accessed",
  "State what common data standards will be applied to the scientific data and associated metadata to enable interoperability of datasets and resources, and provide the name(s) of the data standards that will be applied and describe how these data standards will be applied to the scientific data generated by the research proposed in this project.  If applicable, indicate that no consensus standards exist",

  // Page 2: ele4-a, b, c, ele5-a, b, c
  "Provide the name of the repository(ies) where scientific data and metadata arising from the project will be archived; see Selecting a Data Repository",
  "Describe how the scientific data will be findable and identifiable, i.e., via a persistent unique identifier or other standard indexing tools",
  "Describe when the scientific data will be made available to other users (i.e., no later than time of an associated publication or end of the performance period, whichever comes first) and for how long data will be available",
  "Describe and justify any applicable factors or data use limitations affecting subsequent access, distribution, or reuse of scientific data related to informed consent, privacy and confidentiality protections, and any other considerations that may limit the extent of data sharing",
  "State whether access to the scientific data will be controlled (i.e., made available by a data repository only after approval",
  "If generating scientific data derived from humans, describe how the privacy, rights, and confidentiality of human research participants will be protected (e.g., through de-identification, Certificates of Confidentiality, and other protective measures)",

  // Page 3: ele6
  "Describe how compliance with this Plan will be monitored and managed, frequency of oversight, and by whom at your institution (e.g., titles, roles)",
];

// Fixed manual pagination structure
const fixedGroups = computed(() => {
  const elements = dmpState.value || [];

  return [
    elements.slice(0, 5), // Page 1: ele1a/b/c, ele2, ele3
    elements.slice(5, 11), // Page 2: ele4a/b/c, ele5a/b/c
    elements.slice(11), // Page 3: ele6
  ];
});

const currentElements = computed(
  () => fixedGroups.value[currentPage.value] || [],
);

const scoreOptions = [1, 2, 3, 4, 5];
const errorTypes = [
  "Grammar",
  "Incorrect Fact",
  "Incomplete",
  "Off-topic",
  "Other",
];

function globalIndex(page: number, localIndex: number): number {
  const flatIndex = fixedGroups.value
    .slice(0, page)
    .reduce((sum, group) => sum + group.length, 0);

  return flatIndex + localIndex;
}

function createBlankEvaluation(): any[][] {
  return fixedGroups.value.map((group) =>
    group.map(() => ({
      additionalComments: "",
      completenessScore: null,
      otherError: "",
      satisfactionScore: null,
      selectedErrors: [],
      techCorrectScore: null,
    })),
  );
}

watch(
  fixedGroups,
  () => {
    if (!fixedGroups.value.length) return;
    const saved = evaluationsPerDmp.value[dmpIndex.value];

    if (saved) {
      evaluations.value = JSON.parse(JSON.stringify(saved));
    } else {
      evaluations.value = createBlankEvaluation();
      evaluationsPerDmp.value[dmpIndex.value] = JSON.parse(
        JSON.stringify(evaluations.value),
      );
    }
  },
  { immediate: true },
);

function saveCurrentEvaluation() {
  evaluationsPerDmp.value[dmpIndex.value] = JSON.parse(
    JSON.stringify(evaluations.value),
  );
}

function formatContent(content: string) {
  return content.replace(/\n/g, "<br>");
}

function nextPage() {
  if (currentPage.value === fixedGroups.value.length - 1) {
    saveCurrentEvaluation();
    router.push("/app/overall");
  } else {
    currentPage.value++;
  }
}

function prevPage() {
  if (currentPage.value === 0) {
    saveCurrentEvaluation();
    router.push("/app/preview");
  } else {
    currentPage.value--;
  }
}

// Show title if it's the first element or title differs from previous
function shouldShowTitle(index: number, elements: DmpElement[]) {
  if (index === 0) return true;

  return elements[index].title !== elements[index - 1].title;
}
</script>

<template>
  <div v-if="currentElements.length" class="mt-10 space-y-6">
    <div class="mb-4 text-lg text-gray-700">
      <strong>Section-wise Evaluation ({{ currentPage + 1 }}/3)</strong>
    </div>

    <h1>
      Evaluate each of the sections of the DMP below. The text from each section
      is provided again to facilitate your evaluation.
    </h1>

    <UCard
      v-for="(element, index) in currentElements"
      :key="index"
      class="bg-gray-50 bg-white p-4"
    >
      <div v-if="evaluations[currentPage]?.[index]" class="flex gap-6">
        <div class="w-1/2">
          <h3 class="mb-2 text-xl font-semibold text-gray-800">
            <template v-if="shouldShowTitle(index, currentElements)">
              {{ element.title }}<br />

              <span
                v-if="element.subtitle"
                class="ml-1 text-base font-semibold text-gray-800"
              >
                {{ element.subtitle }}
              </span>
            </template>

            <template v-else-if="element.subtitle">
              <span class="text-base font-semibold text-gray-800">
                {{ element.subtitle }}
              </span>
            </template>
          </h3>

          <div class="mb-3 text-sm text-gray-600 italic">
            ({{ helpTexts[globalIndex(currentPage, index)] }})
          </div>

          <div
            class="text-base whitespace-pre-wrap"
            v-html="formatContent(element.content)"
          />
        </div>

        <div class="w-1/2 space-y-4">
          <div class="flex items-center space-x-4">
            <label class="w-3/4 font-semibold">
              1. How technically correct is the information?
              <span class="text-red-500">*</span>
            </label>

            <USelect
              v-model="evaluations[currentPage][index].techCorrectScore"
              :items="scoreOptions"
              class="w-25"
            />
          </div>

          <div class="flex items-center space-x-4">
            <label class="w-3/4 font-semibold">
              2. Does the section fully address the required Element?
              <span class="text-red-500">*</span>
            </label>

            <USelect
              v-model="evaluations[currentPage][index].completenessScore"
              :items="scoreOptions"
              class="w-25"
            />
          </div>

          <div class="flex items-center space-x-4">
            <label class="w-3/4 font-semibold">
              3. How satisfied are you with the response?
              <span class="text-red-500">*</span>
            </label>

            <USelect
              v-model="evaluations[currentPage][index].satisfactionScore"
              :items="scoreOptions"
              class="w-25"
            />
          </div>

          <div>
            <label class="mb-2 block font-semibold">
              4. What type of error(s) did you find?
              <span class="text-red-500">*</span>
            </label>

            <div class="flex items-start gap-x-4">
              <USelect
                v-model="evaluations[currentPage][index].selectedErrors"
                :items="errorTypes"
                multiple
                placeholder="Select error types"
                class="w-100"
              />

              <UInput
                v-if="
                  evaluations[currentPage][index].selectedErrors.includes(
                    'Other',
                  )
                "
                v-model="evaluations[currentPage][index].otherError"
                placeholder="Specify other error"
                class="w-100"
              />
            </div>
          </div>

          <div>
            <label class="mb-1 block font-semibold">
              5. Provide additional comments (optional)
            </label>

            <UTextarea
              v-model="evaluations[currentPage][index].additionalComments"
              class="w-full"
            />
          </div>
        </div>
      </div>
    </UCard>

    <div class="mt-6 mb-6 flex items-center justify-between">
      <UButton
        icon="i-lucide-arrow-left"
        size="xl"
        color="primary"
        class="flex w-30 items-center justify-center"
        @click="prevPage"
      >
        Previous
      </UButton>

      <UButton
        trailing-icon="i-lucide-arrow-right"
        size="xl"
        color="primary"
        class="flex w-30 items-center justify-center"
        @click="nextPage"
      >
        Next
      </UButton>
    </div>
  </div>
</template>
