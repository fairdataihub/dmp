<script setup lang="ts">
import { computed, watch } from "vue";
import { useRouter, useState } from "#imports";
import type { DmpElement } from "~/server/utils/splitMdByElements";

const router = useRouter();
const toast = useToast();

const currentDmpIndex = useState<number>("dmpIndex");
const overallSatisfaction = ref<number | null>(null);
const overallAuthorshipGuess = ref<string | null>(null);
const overallEvaluationsPerDmp = useState<
  { authorship: string | null; satisfaction: number | null }[]
>("overallEvaluationsPerDmp", () => []);

function saveOverallEvaluation() {
  overallEvaluationsPerDmp.value[dmpIndex.value] = {
    authorship: overallAuthorshipGuess.value,
    satisfaction: overallSatisfaction.value,
  };
}

const dmpState = useState<DmpElement[]>("dmpData");
const dmpIndex = useState<number>("dmpIndex");
const assignedDmps = useState<string[]>("assignedDmps");
const evaluationsPerDmp = useState<any[][][]>("evaluationsPerDmp", () => []);
const evaluations = useState<any[][]>("evaluations", () => []);
const currentPage = useState<number>("currentPage", () => 0);
const helpTexts = [
  // Page 1: ele1-a, b, c, ele2, ele3
  "Summarize the types and estimated amount of scientific data expected to be generated in the project",
  "Describe which scientific data from the project will be preserved and shared and provide the rationale for this decision",
  "Briefly list the metadata, other relevant data, and any associated documentation (e.g., study protocols and data collection instruments) that will be made accessible to facilitate interpretation of the scientific data",
  "State whether specialized tools, software, and/or code are needed to access or manipulate shared scientific data, and if so, provide the name(s) of the needed tool(s) and software and specify how they can be accessed",
  "State what common data standards will be applied to the scientific data and associated metadata to enable interoperability of datasets and resources, and provide the name(s) of the data standards that will be applied and describe how these data standards will be applied to the scientific data generated by the research proposed in this project.  If applicable, indicate that no consensus standards exist",

  // Page 2: ele4-a, b, c, ele5-a, b, c
  "Provide the name of the repository(ies) where scientific data and metadata arising from the project will be archived; see Selecting a Data Repository",
  "Describe how the scientific data will be findable and identifiable, i.e., via a persistent unique identifier or other standard indexing tools",
  "Describe when the scientific data will be made available to other users (i.e., no later than time of an associated publication or end of the performance period, whichever comes first) and for how long data will be available",
  "Describe and justify any applicable factors or data use limitations affecting subsequent access, distribution, or reuse of scientific data related to informed consent, privacy and confidentiality protections, and any other considerations that may limit the extent of data sharing",
  "State whether access to the scientific data will be controlled (i.e., made available by a data repository only after approval",
  "If generating scientific data derived from humans, describe how the privacy, rights, and confidentiality of human research participants will be protected (e.g., through de-identification, Certificates of Confidentiality, and other protective measures)",

  // Page 3: ele6
  "Describe how compliance with this Plan will be monitored and managed, frequency of oversight, and by whom at your institution (e.g., titles, roles)",
];

const groupedElements = computed(() => {
  const elements = dmpState.value || [];
  const groups: { title: string; group: DmpElement[] }[] = [];

  for (const el of elements) {
    const existing = groups.find((g) => g.title === el.title);
    if (existing) {
      existing.group.push(el);
    } else {
      groups.push({ title: el.title, group: [el] });
    }
  }

  return groups;
});

const fixedGroups = computed(() => {
  const groups = groupedElements.value;

  // Separate Element 6
  const ele6Index = groups.findIndex((g) =>
    g.title.startsWith("Element 6: Oversight"),
  );

  const ele6 = ele6Index !== -1 ? groups.splice(ele6Index, 1)[0] : null;

  // Now paginate rest in chunks of 3
  const paginated: typeof groupedElements.value[] = [];
  for (let i = 0; i < groups.length; i += 3) {
    paginated.push(groups.slice(i, i + 3));
  }

  if (ele6) {
    paginated.push([ele6]); // Page 3: Element 6 alone
  }

  return paginated;
});


const currentElements = computed(
  () => fixedGroups.value[currentPage.value] || [],
);

const scoreOptions = [1, 2, 3, 4, 5];
const errorTypes = [
  "Accuracy--Contains incorrect or misleading information, such as mentioning a repository that does not exist",
  "Completeness--Missing something that is required for the Element",
  "Clarity--Uses vague language, such as saying data will be shared but not providing details",
  "Coherence--Information not presented in a logical, organized, and well-connected way",
  "Compliance--Plan would not be in compliance with Funder Policy",
  "Fluency--Contains spelling, punctuation, or grammar issues",
  "Best Practice--Contains plan choices that arenâ€™t recommended",
  "Other--Please mention in comments",
  "None--No errors seen",
];

function globalIndex(page: number, localIndex: number): number {
  const flatIndex = fixedGroups.value
    .slice(0, page)
    .reduce((sum, group) => sum + group.length, 0);

  return flatIndex + localIndex;
}

function createBlankEvaluation(): any[][] {
  return fixedGroups.value.map((group) =>
    group.map(() => ({
      additionalComments: "",
      completenessScore: null,
      otherError: "",
      satisfactionScore: null,
      selectedErrors: [],
      techCorrectScore: null,
    })),
  );
}

watch(
  fixedGroups,
  () => {
    if (!fixedGroups.value.length) return;
    const saved = evaluationsPerDmp.value[dmpIndex.value];

    if (saved) {
      evaluations.value = JSON.parse(JSON.stringify(saved));
    } else {
      evaluations.value = createBlankEvaluation();
      evaluationsPerDmp.value[dmpIndex.value] = JSON.parse(
        JSON.stringify(evaluations.value),
      );
    }
  },
  { immediate: true },
);

watch(
  dmpIndex,
  () => {
    const saved = overallEvaluationsPerDmp.value[dmpIndex.value];

    if (saved) {
      overallSatisfaction.value = saved.satisfaction;
      overallAuthorshipGuess.value = saved.authorship;
    } else {
      overallSatisfaction.value = null;
      overallAuthorshipGuess.value = null;
    }
  },
  { immediate: true },
);

function saveCurrentEvaluation() {
  evaluationsPerDmp.value[dmpIndex.value] = JSON.parse(
    JSON.stringify(evaluations.value),
  );
}

function formatContent(content: string) {
  // Replace multiple newlines with a single <br> (for paragraphs)
  // Replace single newlines or newlines with surrounding whitespace with space
  return content
    .replace(/\r/g, "") // remove carriage returns
    .replace(/\n{2,}/g, "<br><br>") // preserve paragraph breaks
    .replace(/\s*\n\s*/g, " "); // collapse line breaks inside paragraphs
}

function nextPage() {
  saveCurrentEvaluation();

  if (currentPage.value === fixedGroups.value.length - 1) {
    // We're on page 3
    saveOverallEvaluation();

    if (dmpIndex.value < assignedDmps.value.length - 1) {
      dmpIndex.value++; // Next DMP
      currentPage.value = 0;
      router.push("/app/preview");
    } else {
      onSubmitClick(); // ðŸ”¥ Show modal!
    }
  } else {
    currentPage.value++;
  }
}

function prevPage() {
  if (currentPage.value === 0) {
    saveCurrentEvaluation();
    router.push("/app/preview");
  } else {
    currentPage.value--;
  }
}

function flattenedIndex(groupIndex: number, subIndex: number): number {
  let index = 0;

  // Count all sub-elements from previous pages
  for (let p = 0; p < currentPage.value; p++) {
    for (const group of fixedGroups.value[p]) {
      index += group.group.length;
    }
  }

  // Add sub-elements before current subEl in current page
  for (let g = 0; g < groupIndex; g++) {
    index += currentElements.value[g].group.length;
  }

  // Add offset within current group
  index += subIndex;

  return index;
}


const isLastPageAndLastDmp = computed(
  () =>
    currentPage.value === fixedGroups.value.length - 1 &&
    dmpIndex.value === assignedDmps.value.length - 1,
);

const open = ref(false);

function onSubmitClick() {
  open.value = true;
}

async function confirmSubmit() {
  open.value = false;
  await saveAllEvaluations();
}

async function saveAllEvaluations() {
  try {
    const flatElements = dmpState.value;
    const flatEvaluations = evaluations.value.flatMap((group) => group);
    const dmpName = assignedDmps.value[dmpIndex.value];

    const res = await $fetch("/api/dmp/save-evaluation", {
      body: {
        dmpName,
        elements: flatElements,
        evaluations: flatEvaluations,
        overallAuthorshipGuess: overallAuthorshipGuess.value,
        overallSatisfaction: overallSatisfaction.value,
      },
      method: "POST",
    });

    toast.add({
      title: "Saved",
      description: res.message || "Evaluation results saved successfully.",
    });

    router.push("/app/thank-you");
  } catch (error) {
    console.error("Save failed:", error);
    toast.add({
      title: "Error",
      description: "Failed to save evaluations. Please try again.",
    });
  }
}
</script>

<template>
  <div v-if="currentElements.length" class="mt-10 space-y-6">
    <div class="mb-4 text-lg text-gray-700">
      <strong>DMP #{{ currentDmpIndex + 1 }} â€“ Section-wise Evaluation ({{ currentPage + 1 }}/3)</strong>
    </div>

    <h1>
      Evaluate each of the sections of the DMP below. The text from each section
      is provided again to facilitate your evaluation.
    </h1>

<UCard
  v-for="(group, groupIndex) in currentElements"
  :key="groupIndex"
  class="bg-gray-50 bg-white p-4"
>
  <div v-if="evaluations[currentPage]?.[groupIndex]" class="flex gap-6">
    <div class="w-1/2">
      <h3 class="mb-2 text-xl font-semibold text-gray-800">
        {{ group.title }}
      </h3>

      <div
        v-for="(subEl, subIndex) in group.group"
        :key="subIndex"
        class="mb-4"
      >
        <div class="text-base font-semibold text-gray-800">
          {{ subEl.subtitle }}
        </div>

        <div class="mb-2 text-sm italic text-gray-600">
          ({{ helpTexts[flattenedIndex(groupIndex, subIndex)] }})
        </div>

        <div
          class="text-base whitespace-pre-wrap"
          v-html="formatContent(subEl.content)"
        />
      </div>
    </div>

    <div class="w-1/2 space-y-4">
      <!-- Same evaluation UI for the entire group -->
      <div class="flex items-center space-x-4">
        <label class="w-3/4 font-semibold">
          1. How satisfied are you with the response to this Element?
          <span class="text-red-500">*</span>
        </label>

        <USelect
          v-model="evaluations[currentPage][groupIndex].techCorrectScore"
          :items="scoreOptions"
          class="w-45"
        />
      </div>

      <div>
        <label class="mb-2 block font-semibold">
           2. What type of errors did you find, if any (select all that apply)?
          <span class="text-red-500">*</span>
        </label>

        <div class="flex items-start gap-x-4">
          <USelect
            v-model="evaluations[currentPage][groupIndex].selectedErrors"
            :items="errorTypes"
            multiple
            placeholder="Select error types"
            class="w-full"
          />
        </div>
      </div>

      <div>
        <label class="mb-1 block font-semibold">
          3. Provide additional comments (optional)
        </label>

        <UTextarea
          v-model="evaluations[currentPage][groupIndex].additionalComments"
          class="w-full"
        />
      </div>
    </div>
  </div>
</UCard>


    <UCard
      v-if="currentPage === 2"
      class="space-y-8 bg-gray-50 bg-white px-2 pt-6"
    >
      <div class="mb-4 text-center text-xl font-bold">Overall Evaluation</div>
<p class="text-base">Provide an overall evaluation of this DMP below. 
</p>
      <!-- Question 1 -->
      <div class="mb-6 flex gap-x-8">
        <div class="w-1/2">
          <label class="w-3/4 font-semibold">
            1. How satisfied were you with this DMP as a whole?
            <span class="text-red-500">*</span>
          </label>
        </div>

        <div class="w-1/2">
          <USelect
            v-model="overallSatisfaction"
            :items="[
              { label: 'Very Dissatisfied', value: 1 },
              { label: 'Dissatisfied', value: 2 },
              { label: 'Neutral', value: 3 },
              { label: 'Satisfied', value: 4 },
              { label: 'Very Satisfied', value: 5 },
            ]"
            placeholder="Select satisfaction level"
            class="w-96"
          />
        </div>
      </div>

      <!-- Question 2 -->
      <div class="flex gap-x-8">
        <div class="w-1/2">
          <label class="w-3/4 font-semibold">
            2. If you had to guess, would you think this DMP was more likely to have been written by a human or by an LLM?
            <span class="text-red-500">*</span>
          </label>
        </div>

        <div class="w-1/2">
          <USelect
            v-model="overallAuthorshipGuess"
            :items="[
              { label: 'Human', value: 'Human' },
              { label: 'LLM', value: 'LLM' },
            ]"
            placeholder="Select one"
            class="w-96"
          />
        </div>
      </div>
    </UCard>

    <div class="mt-6 mb-6 flex items-center justify-between">
      <UButton
        icon="i-lucide-arrow-left"
        size="xl"
        color="primary"
        class="flex w-30 items-center justify-center"
        @click="prevPage"
      >
        Previous
      </UButton>

      <UButton
        :trailing-icon="isLastPageAndLastDmp ? '' : 'i-lucide-arrow-right'"
        size="xl"
        color="primary"
        class="flex w-30 items-center justify-center"
        @click="nextPage"
      >
        {{ isLastPageAndLastDmp ? "Submit" : "Next" }}
      </UButton>
    </div>

    <UModal v-model:open="open" trap-focus>
      <template #content>
        <div class="w-120 max-w-full p-6">
          <p class="mb-6">Are you sure you want to submit your evaluations?</p>

          <div class="flex justify-end space-x-4">
            <UButton color="primary" @click="confirmSubmit"
              >Yes, Submit</UButton
            >

            <UButton color="neutral" @click="open = false">Cancel</UButton>
          </div>
        </div>
      </template>
    </UModal>
  </div>
</template>
